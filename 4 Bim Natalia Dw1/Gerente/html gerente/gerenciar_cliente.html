<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciar Clientes</title>
  <link rel="stylesheet" href="../style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
</head>
<body>

<header class="top-bar">
  <h1>Gerenciar Clientes</h1>
  <div class="top-right-buttons">
    <button onclick="window.location.href='menu_gerente.html'">Voltar ao Menu</button>
  </div>
</header>

<main>
  <div class="gerenciar-produtos-container">
    <h2>Cadastro / Edi√ß√£o de Cliente</h2>

    <button id="selecionar-cliente-btn" onclick="toggleListaClientes()">Selecionar Cliente</button>
    <ul id="lista-clientes" style="display:none;"></ul>

    <form id="form-cliente" onsubmit="salvarCliente(event)">
      <label for="cliente-nome">Nome:</label>
      <input type="text" id="cliente-nome" required />

      <label for="cliente-data">Data de Nascimento:</label>
      <input type="date" id="cliente-data" required />

      <label for="cliente-email">Email:</label>
      <input type="email" id="cliente-email" required />

      <label for="cliente-senha">Senha:</label>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="password" id="cliente-senha" required />
        <button type="button" id="toggleSenha" tabindex="-1" style="padding:2px 8px;">üëÅÔ∏è</button>
      </div>

      <label for="cliente-renda">Renda:</label>
      <input type="number" id="cliente-renda" step="0.01" required />

      <label for="cliente-data-cadastro">Data de Cadastro:</label>
      <input type="date" id="cliente-data-cadastro" required />

      <button type="submit">Salvar Cliente</button>
      <button type="button" onclick="excluirCliente()">Excluir Cliente</button>
    </form>
  </div>
</main>

<script>
  let clientes = [];
  let clienteEditando = null;

  async function carregarClientes() {
    const res = await fetch('http://localhost:3001/cliente');
    clientes = await res.json();
    atualizarListaClientes();
  }

  function toggleListaClientes() {
    const lista = document.getElementById('lista-clientes');
    if (lista.style.display === 'block') {
      lista.style.display = 'none';
    } else {
      carregarClientes();
      lista.style.display = 'block';
    }
  }

  function atualizarListaClientes() {
    const lista = document.getElementById('lista-clientes');
    lista.innerHTML = '';
    clientes.forEach((cliente, index) => {
      const nomeExibir = cliente.nomepessoa || cliente.pessoacpfpessoa || cliente.emailpessoa || 'Cliente';
      const li = document.createElement('li');
      li.textContent = `${nomeExibir}`;
      li.onclick = () => {
        carregarCliente(index);
        lista.style.display = 'none';
      };
      lista.appendChild(li);
    });
  }

  function carregarCliente(index) {
    const cliente = clientes[index];
    if (cliente) {
      clienteEditando = index;
      document.getElementById('cliente-nome').value = cliente.nomepessoa || '';
      document.getElementById('cliente-data').value = cliente.datanascimentopessoa ? cliente.datanascimentopessoa.split('T')[0] : '';
      document.getElementById('cliente-email').value = cliente.emailpessoa || '';
      document.getElementById('cliente-senha').value = cliente.senhapessoa || '';
      document.getElementById('cliente-renda').value = cliente.rendacliente || '';
      document.getElementById('cliente-data-cadastro').value = cliente.datadecadastrocliente ? cliente.datadecadastrocliente.split('T')[0] : '';
      document.getElementById('cliente-email').disabled = true;
    }
  }

  async function salvarCliente(event) {
    event.preventDefault();
    if (clienteEditando === null) {
      alert('Selecione um cliente para editar.');
      return;
    }
    const cliente = clientes[clienteEditando];
    const nome = document.getElementById('cliente-nome').value.trim();
    const dataNascimento = document.getElementById('cliente-data').value;
    const email = document.getElementById('cliente-email').value;
    const senha = document.getElementById('cliente-senha').value;
    const rendaCliente = document.getElementById('cliente-renda').value;
    const dataDeCadastroCliente = document.getElementById('cliente-data-cadastro').value;
    if (!nome || !dataNascimento || !email || !senha || !rendaCliente || !dataDeCadastroCliente) {
      alert('Preencha todos os campos corretamente!');
      return;
    }
    const novoCliente = {
      nomePessoa: nome,
      dataNascimentoPessoa: dataNascimento,
      emailPessoa: email,
      senhaPessoa: senha,
      rendaCliente,
      dataDeCadastroCliente
    };
    const res = await fetch(`http://localhost:3001/cliente/${encodeURIComponent(cliente.pessoacpfpessoa)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(novoCliente)
    });
    const data = await res.json();
    if (data.error) {
      alert(data.error);
    } else {
      alert(data.mensagem || 'Cliente atualizado!');
      limparFormulario();
      await carregarClientes();
    }
  }

  async function excluirCliente() {
    if (clienteEditando === null) {
      alert('Selecione um cliente para excluir.');
      return;
    }
    const cliente = clientes[clienteEditando];
    const confirmacao = confirm('Tem certeza que deseja excluir este cliente?');
    if (confirmacao) {
      const res = await fetch(`http://localhost:3001/cliente/${encodeURIComponent(cliente.pessoacpfpessoa)}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.error) {
        alert(data.error);
      } else {
        alert(data.mensagem || 'Cliente exclu√≠do.');
        limparFormulario();
        await carregarClientes();
      }
    }
  }

  function limparFormulario() {
    clienteEditando = null;
    document.getElementById('form-cliente').reset();
    document.getElementById('cliente-email').disabled = false;
  }

  // Mostrar/ocultar senha
  document.addEventListener('DOMContentLoaded', function() {
    const senhaInput = document.getElementById('cliente-senha');
    const toggleBtn = document.getElementById('toggleSenha');
    if (toggleBtn) {
      toggleBtn.onclick = function() {
        if (senhaInput.type === 'password') {
          senhaInput.type = 'text';
          toggleBtn.textContent = 'üôà';
        } else {
          senhaInput.type = 'password';
          toggleBtn.textContent = 'üëÅÔ∏è';
        }
      };
    }
  });

  window.addEventListener('DOMContentLoaded', carregarClientes);
</script>

</body>
</html>
